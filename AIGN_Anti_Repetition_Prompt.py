#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
AI网络小说生成器 - 防重复机制提示词
用于解决大模型生成内容重复段落的问题
"""

# ==============================================================================
# 防重复核心机制
# ==============================================================================

anti_repetition_core = """
## 🚫 防重复机制（必须严格遵守）

### 一、重复检测规则
1. **段落级检测**：
   - 禁止连续两段开头结构相似（如都以"他..."、"她..."开始）
   - 禁止连续段落使用相同的句式结构
   - 禁止在3段内重复相同的场景描写模式

2. **句子级检测**：
   - 禁止连续3个句子使用相同的主语
   - 禁止连续句子使用相同的句式（如都是"...了...，...了..."）
   - 禁止在5句内重复使用相同的形容词或副词

3. **词汇级检测**：
   - 禁止在100字内重复使用相同的动词（除基础动词如"说"、"看"等）
   - 禁止在200字内重复使用相同的成语或俗语
   - 禁止在同一段落内重复使用相同的比喻

### 二、内容推进机制
1. **信息递进原则**：
   - 每段必须包含至少一个新信息点
   - 每段必须推进剧情或深化人物
   - 禁止原地踏步式的重复描写

2. **变化要求**：
   - 场景变化：环境细节必须有所不同
   - 情绪变化：人物情感必须有所发展
   - 节奏变化：快慢节奏必须交替进行

### 三、表达多样化策略
1. **句式变化库**：
   - 陈述句、疑问句、感叹句、祈使句轮换使用
   - 长句、短句、中句合理搭配
   - 单句、复句、并列句、主从句交替出现

2. **描写角度轮换**：
   - 视觉描写→听觉描写→触觉描写→心理描写→动作描写
   - 全景描写→特写描写→细节描写→氛围描写
   - 直接描写→间接描写→侧面描写→对比描写

3. **词汇替换表**：
   - 使用同义词库避免重复
   - 使用不同修辞手法表达相同含义
   - 使用不同语言风格（文雅/通俗/口语）交替

### 四、重复预防检查清单
生成内容前必须检查：
□ 上文最后3段的开头词汇和句式
□ 上文使用过的主要动词和形容词
□ 上文的场景描写模式和角度
□ 上文的段落结构和节奏模式
□ 上文的情绪基调和氛围营造手法

生成内容后必须检查：
□ 是否有段落结构重复
□ 是否有句式模式重复
□ 是否有词汇过度重复
□ 是否有场景描写重复
□ 是否有情节原地踏步
"""

# ==============================================================================
# 正文生成防重复增强
# ==============================================================================

novel_writer_anti_repetition = """
## 📝 正文生成防重复专项要求

### 一、记忆追踪机制
**必须记录并避免重复以下内容：**
1. **上文使用过的开头模式**（最近5段）
2. **上文使用过的转折词**（最近10个）
3. **上文使用过的场景切换方式**（最近3次）
4. **上文使用过的情绪表达方式**（最近5种）
5. **上文使用过的对话引入方式**（最近5次）

### 二、强制变化规则
1. **开头变化强制要求**：
   - 如果上段以人物动作开头，本段必须以环境描写、对话或心理描写开头
   - 如果上段以对话开头，本段必须以叙述或描写开头
   - 如果上段以环境描写开头，本段必须以人物或事件开头

2. **节奏变化强制要求**：
   - 如果上段节奏紧张，本段必须有缓和元素
   - 如果上段是纯对话，本段必须加入描写
   - 如果上段是纯描写，本段必须有动作推进

3. **描写焦点强制轮换**：
   - 不能连续3段都聚焦同一个人物
   - 不能连续2段都描写同一类感官
   - 不能连续2段都使用同一种修辞手法

### 三、创新表达要求
1. **每段必须包含一个独特元素**：
   - 独特的比喻或意象
   - 独特的细节观察
   - 独特的情感表达
   - 独特的语言节奏

2. **禁用模板化表达**：
   - 禁止"他/她+动词+了+..."的单调句式连用
   - 禁止"首先...然后...最后..."的流水账式叙述
   - 禁止"突然..."、"忽然..."的滥用
   - 禁止"只见..."、"但见..."的陈词滥调

### 四、剧情推进保证
**每段必须完成以下至少一项：**
□ 揭示一个新信息
□ 推进一个事件发展
□ 深化一个人物特征
□ 转变一种关系状态
□ 改变一个场景氛围
□ 引入一个新的冲突点

### 五、自检机制
生成每段后立即自检：
1. 本段开头是否与上段相似？→如是，立即重写
2. 本段主要动词是否在上文出现过3次以上？→如是，替换
3. 本段是否推进了剧情？→如否，增加新元素
4. 本段是否有独特表达？→如否，创新描写
5. 本段是否与上段节奏相同？→如是，调整节奏
"""

# ==============================================================================
# 润色防重复增强
# ==============================================================================

novel_embellisher_anti_repetition = """
## ✨ 润色防重复专项要求

### 一、润色多样化原则
1. **描写手法轮换**：
   - 第1处润色：增加感官细节
   - 第2处润色：增加心理活动
   - 第3处润色：增加环境烘托
   - 第4处润色：增加动作细节
   - 第5处润色：增加对话潜台词
   （循环使用，避免单一手法）

2. **句式改造多样化**：
   - 简单句→复合句
   - 主动句→被动句
   - 陈述句→反问句
   - 顺序句→倒装句
   （每种改造不能连续使用2次）

3. **修辞手法分散使用**：
   - 比喻、拟人、排比、对比、夸张等修辞
   - 同一种修辞手法间隔至少200字
   - 避免修辞堆砌，保持自然流畅

### 二、词汇丰富化策略
1. **动词多样化**：
   - 基础动词精确化：走→踱步/疾行/漫步/踯躅
   - 表情动词细分化：笑→莞尔/哂笑/大笑/苦笑
   - 动作动词形象化：看→瞥/瞪/凝视/扫视

2. **形容词层次化**：
   - 避免"很"、"非常"等程度副词
   - 使用具体形象的形容词
   - 形容词与名词的新颖搭配

3. **成语俗语控制**：
   - 每500字最多使用1个成语
   - 优先使用生动的动词短语
   - 避免生僻或过于文言的表达

### 三、节奏变化保证
1. **句子长度变化**：
   - 5-10字的短句
   - 15-25字的中句
   - 30字以上的长句
   （必须交替出现，避免单一节奏）

2. **段落长度变化**：
   - 50-100字的短段
   - 150-250字的中段
   - 300字以上的长段
   （合理分配，避免视觉疲劳）

### 四、润色前后对比检查
润色完成后必须检查：
1. **重复率检查**：
   □ 相同词汇重复率是否降低30%以上
   □ 相同句式重复率是否降低50%以上
   □ 相同开头重复率是否降低70%以上

2. **多样性检查**：
   □ 是否使用了至少3种不同的描写手法
   □ 是否包含至少5种不同的句式结构
   □ 是否运用了至少3种不同的修辞手法

3. **流畅性检查**：
   □ 润色后是否保持逻辑连贯
   □ 润色后是否符合人物性格
   □ 润色后是否维持原有节奏意图
"""

# ==============================================================================
# 检测与修正流程
# ==============================================================================

repetition_detection_workflow = """
## 🔍 重复检测与修正工作流

### 第一步：预生成检测
1. 扫描上文最后1000字
2. 提取高频词汇（出现3次以上）
3. 识别重复句式模式
4. 标记已使用的描写手法
5. 记录段落开头模式

### 第二步：生成中监控
1. 每生成100字暂停检查
2. 对比新内容与标记内容
3. 发现重复立即调整
4. 确保信息增量
5. 验证剧情推进

### 第三步：后生成修正
1. 全文重复率扫描
2. 句式多样性评估
3. 词汇丰富度检查
4. 节奏变化验证
5. 必要时局部重写

### 第四步：最终优化
1. 替换高频词汇
2. 调整重复句式
3. 增加变化元素
4. 确保阅读流畅
5. 保持风格统一

## 🎯 关键指标
- 词汇重复率：< 15%（基础词汇除外）
- 句式重复率：< 10%
- 段落结构重复率：< 5%
- 信息增量率：> 80%（每段都有新内容）
- 表达多样性指数：> 7/10
"""

# ==============================================================================
# 导出函数
# ==============================================================================

def get_anti_repetition_core():
    """获取防重复核心机制"""
    return anti_repetition_core

def get_novel_writer_anti_repetition():
    """获取正文生成防重复增强"""
    return novel_writer_anti_repetition

def get_novel_embellisher_anti_repetition():
    """获取润色防重复增强"""
    return novel_embellisher_anti_repetition

def get_repetition_detection_workflow():
    """获取重复检测与修正工作流"""
    return repetition_detection_workflow

def enhance_prompt_with_anti_repetition(original_prompt, prompt_type="writer"):
    """
    为原始提示词添加防重复机制
    
    Args:
        original_prompt: 原始提示词
        prompt_type: 提示词类型 ("writer" 或 "embellisher")
    
    Returns:
        增强后的提示词
    """
    anti_rep_core = get_anti_repetition_core()
    
    if prompt_type == "writer":
        specific_anti_rep = get_novel_writer_anti_repetition()
    elif prompt_type == "embellisher":
        specific_anti_rep = get_novel_embellisher_anti_repetition()
    else:
        specific_anti_rep = ""
    
    workflow = get_repetition_detection_workflow()
    
    # 在原始提示词的Workflows部分之前插入防重复机制
    enhanced_prompt = original_prompt
    
    # 找到Workflows部分
    if "## Workflows:" in enhanced_prompt:
        parts = enhanced_prompt.split("## Workflows:")
        enhanced_prompt = parts[0] + anti_rep_core + "\n\n" + specific_anti_rep + "\n\n" + workflow + "\n\n## Workflows:" + parts[1]
    else:
        # 如果没有找到Workflows，就添加到末尾
        enhanced_prompt = enhanced_prompt + "\n\n" + anti_rep_core + "\n\n" + specific_anti_rep + "\n\n" + workflow
    
    return enhanced_prompt